## ì´ë¯¸ì§€ ì—…ë¡œë“œ & ë‹¤ìš´ë¡œë“œ

***URLSession Download Task ì´ìš©í•´ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ***

âœ”ï¸ ìºì‹œì— ìˆëŠ” ê²½ìš° ë‹¤ìš´ë¡œë“œ í•˜ì§€ ì•ŠìŒ & ìºì‹œì— ì—†ëŠ” ê²½ìš° ë‹¤ìš´ë¡œë“œ ì‹¤í–‰

 DownloadTaskì„ ì´ìš©í•´ì„œ ë‹¤ìš´ë¡œë“œë¥¼ ë°›ì„ ë•Œ, ì™„ë£Œ í›„ ì¼ì‹œì ì¸ ê³µê°„ì— í•´ë‹¹ íŒŒì¼ì´ ì €ì¥ë˜ê²Œ ëœë‹¤. ì´ë¥¼ ë³´ê´€í•˜ê¸°ë¥¼ ì›í•œë‹¤ë©´ ê¼­ Handlerê°€ ëë‚˜ê¸° ì „ì— ë‹¤ë¥¸ ê³µê°„ì— ì €ì¥í•´ì•¼í•œë‹¤.

 ì—¬ê¸°ì„œ Downloadì„ ë°›ëŠ” ë™ì•ˆ ì§„í–‰ê³¼ì •ì— ëŒ€í•œ ì—…ë°ì´íŠ¸ë¥¼ ë°›ê¸°ë¥¼ ì›í•˜ë©´ ê¼­ `URLSessionTaskDelegate`, `URLSessionDownloadDelegate`ì„ ì‚¬ìš©í•˜ì—¬ì•¼ í•œë‹¤.

 ìš°ì„  URLSessionì— ëŒ€í•œ ìƒì„±ì´ í•„ìš”í•˜ë‹¤.

```swift
class FriendViewController: UIViewController {
  // Delegate ì§€ì •ì„ ìœ„í•´ Lazyë¡œ ì„ ì–¸
  lazy var downloadSession: URLSession = {
        let configutaion = URLSessionConfiguration.default
        return URLSession(configuration: configutaion, delegate: self, delegateQueue: nil)
    }()
}

extension FriendViewController: URLSessionTaskDelegate, URLSessionDownloadDelegate {
  // Donwload Taskê°€ ì™„ë£Œëœ í›„ì— ë¶ˆë¦¬ëŠ” ë©”ì†Œë“œ
  func urlSession(_ session: URLSession, downloadTask: URLSessionDownloadTask, didFinishDownloadingTo location: URL) {
    print(location.absoluteURL)
  }
  
  // Download Taskê°€ ì§„í–‰ë˜ëŠ” ë™ì•ˆ ì§„í–‰ìƒí™©ì„ ë‚˜íƒ€ë‚´ëŠ” ë©”ì†Œë“œ
  func urlSession(_ session: URLSession, downloadTask: URLSessionDownloadTask, didWriteData bytesWritten: Int64, totalBytesWritten: Int64, totalBytesExpectedToWrite: Int64) {
    let calculatedProgress = Float(totalBytesWritten) / Float(totalBytesExpectedToWrite)
    print(calculatedProgress)
  }
}
```

<br>

ê¸°ë³¸ì ì¸ URLSessionì„ ìƒì„±í•˜ê³  ì…‹íŒ…í•œ ë°©ë²•ì´ë‹¤. ì´í›„ Request ë°©ì‹ì„ ì„¤ì •í•˜ê³  í†µì‹ ì„ í•˜ëŠ” ê³¼ì •ì´ í•„ìš”í•˜ë‹¤.

1ï¸âƒ£ URLSession

> í†µì‹ ì„ í•˜ëŠ” í° ë°©ë²•ì´ë‹¤. 3ê°€ì§€ë¥¼ ì§€ì›í•œë‹¤.

2ï¸âƒ£ URLRequest

> ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚¼ ë•Œ,ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë³´ë‚¼ì§€ ì–´ë–¤ HTTP ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•  ê²ƒì¸ì§€ ì–´ë–¤ ë‚´ìš©ì„ ë³´ë‚¼ì§€ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ê°ì²´ì´ë‹¤.

3ï¸âƒ£ Task

> ê°ì²´ê°€ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚¸ í›„, ì‘ë‹µì„ ë°›ì„ ë•Œ URL ê¸°ë°˜ì˜ ë‚´ìš©ë“¤ì„ ë°›ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. 3ê°€ì§€ ì¢…ë¥˜ì˜ Taskê°€ ì§€ì›ëœë‹¤.
>
> ğŸ‘‰ Data Task
>
> ğŸ‘‰ Download Task
>
> ğŸ‘‰ Upload Task

<br>

âœ”ï¸ URLRequest ì„¸íŒ…í•˜ëŠ” ë²•

```swift
// HTTP MethodëŠ” POST ë°©ì‹ìœ¼ë¡œ í†µì‹ 
// Header Typeì€ JSON í˜•ì‹ìœ¼ë¡œ ì£¼ê³  ë°›ìŒ
let url = URL(string: "https://example.com/post")!
var request = URLRequest(url: url)
request.httpMethod = "POST"
request.setValue("application/json", forHTTPHeaderField: "Content-Type")
```

<br>

 ë‹¤ìš´ë¡œë“œë¥¼ ì²˜ë¦¬í•´ ì¤„, DownloadService ê°ì²´ë¥¼ ìƒì„± í›„, URLSessionì˜ DownloadTaskì„ í™œìš©í•´ êµ¬í˜„í•˜ì˜€ë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ DownloadTaskì„ í™œìš©í•´ ë‹¤ìš´ì´ ë°›ì•„ì§€ëŠ” íŒŒì¼ë“¤ì˜ ìœ„ì¹˜ë¥¼ ë³´ë©´ tmpì— ë‹¤ìš´ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ë¥¼ Cacheë¡œ ì €ì¥ì„ í•˜ê³  Cacheì— ìˆì„ ì‹œ DownloadTaskì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ Cacheì—ì„œ ë¶ˆëŸ¬ì™€ì„œ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬ë¥¼ í•˜ë ¤ê³  í•œë‹¤.

```swift
struct DownloadService {
  static let shared = DownloadService()
  
  // completionì—ëŠ” ê° Controllerì—ì„œ ì‚¬ìš©ë˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•´ì„œ ë˜ì ¸ì¤€ í›„, Taskê°€ ì‹¤í–‰ë˜ê³ ë‚œ í›„ ì‹¤í–‰ë˜ê²Œ í•¨.
  func download(from url: String, session: URLSession, completion: @escaping (NetworkResult<Any>) -> Void) {
    guard let url = URL(string: url) else { return }
    let request = URLRequest(url: url)
    var cachePath = FileManager.default.urls(for: .cachesDirectory, in: .userDomainMask).first
    cachePath?.appendPathComponent(url.lastPathComponent)
    
    let downloadTask = session.downloadTask(with: reqeust) { 
      location, response, error in
      // ë” í•˜ìœ„ ê°œë…ì¸ HTTPResponseë¡œ ìºìŠ¤íŒ…í•˜ì—¬ statusCode í™•ì¸í•˜ì—¬ ë¶„ê¸°ì²˜ë¦¬  
      guard let response = response as? HTTPURLResponse else { return }
      switch response.statusCode {
        // ì„±ê³µì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë‹¤ìš´ë°›ì•„ì˜¨ ê²½ìš° tmp --> cache í´ë”ë¡œ ë³µì‚¬í•˜ê¸°
        case 200:
        try? FileManager.default.copyItem(at: location!, to: cachePath!)
        complection(.success(cachePath))
        case 400: complection(.pathErr)
        case 500: complection(.serverErr)
        default: complection(.networkFail)
      }
      
      // Cacheì— ìˆëŠ” ê²½ìš°ëŠ” cacheì— ìˆëŠ” íŒŒì¼ ì‚¬ìš©
      // Cacheì— ì—†ëŠ” ê²½ìš°ëŠ” Download Task ì‹¤í–‰
      if !FileManager.default.fileExists(atPath: cachePath!.absoluteString) { downloadTask.resume() }
      else { completion(.success(cachePath!)) }
		}
  }
}
```





***KINGFISHER ì´ìš©í•´ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ***

